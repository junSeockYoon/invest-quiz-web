<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="test">

    <!-- 마지막 유저 번호 조회 -->
    <select id="getLastUserNumber" resultType="int">
        SELECT COALESCE(MAX(CAST(SUBSTRING(user_name, 6) AS UNSIGNED)), 0) AS last_number
        FROM test_results
        WHERE user_name LIKE 'USER_%'
    </select>

    <!-- 퀴즈 결과 저장 -->
    <insert id="insertResult" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO test_results (user_name, total_score, chapter_id, grade)
        VALUES (#{userName}, #{totalScore}, #{chapterId}, '')
    </insert>

    <!-- 퀴즈 상세 결과 저장 (단일) -->
    <insert id="insertDetail">
        INSERT INTO test_details (result_id, question_num, user_answer, is_correct, response_time_ms)
        VALUES (#{resultId}, #{questionNum}, #{userAnswer}, #{isCorrect}, #{responseTimeMs})
    </insert>

    <!-- 챕터 목록 조회 -->
    <select id="getChapters">
        SELECT 
            c.id,
            c.title AS chapter_title,
            c.description AS chapter_description,
            COUNT(q.id) AS question_count
        FROM chapters c
        LEFT JOIN questions q ON c.id = q.chapter_id
        GROUP BY c.id, c.title, c.description
        ORDER BY c.id ASC
    </select>

    <!-- 챕터별 문제 조회 -->
    <select id="getQuestionsByChapter">
        SELECT 
            q.question_num, 
            q.content, 
            q.answer, 
            c.title AS chapter_title, 
            c.description AS chapter_description
        FROM questions q
        JOIN chapters c ON q.chapter_id = c.id
        WHERE c.id = #{chapterId}
        ORDER BY q.question_num ASC
    </select>

    <!-- 관리자 대시보드: 챕터별 요약 통계 -->
    <select id="getAdminChapterSummary">
        SELECT
            c.id AS chapter_id,
            c.title AS chapter_title,
            COUNT(r.id) AS attempt_count,
            COALESCE(AVG(r.total_score), 0) AS avg_score
        FROM chapters c
        LEFT JOIN test_results r ON r.chapter_id = c.id
        GROUP BY c.id, c.title
        ORDER BY c.id ASC
    </select>

    <!-- 관리자 대시보드: 최근 결과 목록 -->
    <select id="getAdminRecentResults">
        SELECT
            r.id,
            r.user_name AS user_name,
            r.total_score AS total_score,
            r.chapter_id AS chapter_id,
            c.title AS chapter_title,
            r.created_at AS created_at
        FROM test_results r
        JOIN chapters c ON r.chapter_id = c.id
        ORDER BY r.created_at DESC
        LIMIT 50
    </select>

</mapper>